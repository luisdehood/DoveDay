<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Tu cumplido</title>

  <!-- Tipografías -->
  <style>
  @font-face {
    font-family: 'Caveat';
    src: url('assets/fonts/Caveat-Regular.woff2') format('woff2');
    font-weight: normal;
    font-style: normal;
  }
  </style>
  <link rel="stylesheet" href="assets/fonts/sofia-pro.css">
  

  <style>
    :root{
      --dove-navy:#00105d;
      --pink:#F29FC5;
      --card-w: 540px; /* ancho de la tarjeta */
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; background:#fafafa; color:var(--dove-navy);
      font-family:"Sofia Pro", system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale;
      display:grid; place-items:center; padding:32px 16px;
    }

    .wrap{ width:100%; max-width:760px; text-align:center; }
    .card{
      width:100%; max-width:var(--card-w);
      background:#fff; margin:0 auto; padding:28px 28px 36px;
      border-radius:16px;
      box-shadow:0 14px 36px rgba(0,0,0,.12);
      text-align:left;
    }
    .card p{ margin:0 0 18px 0; line-height:1.6; font-size:18px; font-weight:400; }
    .saludo{ font-weight:700; margin-bottom:18px; }
    .lead-in{ margin-top:6px; }
    .micro{ font-style:italic; opacity:.9; }

    .label-adj{ margin:18px 0 8px; font-weight:600; }
    .adjetivo{
      font-weight:900; color:var(--pink); font-size:64px; line-height:1; margin:6px 0 10px;
      text-transform:lowercase; letter-spacing:.5px;
      text-align: center;
    }
    .frase{
      font-family:"Caveat", cursive, "Sofia Pro", system-ui, sans-serif;
      font-size:30px; line-height:1.25; text-align:center; margin:10px auto 18px;
      max-width: 420px;
      display:block; text-align:center;
      margin-left:auto; margin-right:auto;
    }
    .logo-dove{ display:block; margin:18px auto 0; width:52px; height:auto; }

    .sticker{ width:64px; height:auto; position:absolute; }
    .sticker.top-right{ right:24px; top:18px; }
    .sticker.mid-right{ right:24px; bottom:120px; }

    .card-frame{ position:relative; }

    .share{ margin-top:22px; display:grid; place-items:center; gap:10px; }
    .btn-share{ 
      display:inline-flex; align-items:center; gap:10px; 
      background:#e9a4c4; color:#00105d; border:0; border-radius:999px; 
      padding:12px 18px; font-weight:700; font-size:16px; cursor:pointer; 
      box-shadow:0 6px 18px rgba(0,0,0,.08);
    }
    .btn-share:hover{ filter:brightness(0.96); }
    .share-icon{ width:22px; height:auto; }
    .share p{ margin:0; font-size:16px; font-weight:700; }

    /* Responsive */
    @media (max-width:560px){
      .card{ padding:22px 20px 28px }
      .card p{ font-size:16px }
      .adjetivo{ font-size:52px }
      .frase{ font-size:26px }
    }

    /* Toast guía para iOS/Safari */
    .toast{ position:fixed; left:50%; transform:translateX(-50%); bottom:16px; 
      background:rgba(0,0,0,.82); color:#fff; padding:10px 14px; border-radius:999px; 
      font-size:14px; font-weight:600; z-index:9999; opacity:0; transition:opacity .2s ease; }
    .toast.show{ opacity:1; }

    /* Overlay de carga */
    .loading-overlay{position:fixed; inset:0; background:#ffffff; z-index:9998; display:flex; flex-direction:column; align-items:center; justify-content:center; gap:18px;}
    .loading-title{ color:var(--dove-navy); font-weight:800; font-size:22px; text-align:center; }
    .loading-sub{ color:var(--dove-navy); opacity:.8; font-size:14px; text-align:center; max-width: 80%; }
    .spinner{ width:42px; height:42px; border-radius:50%; border:4px solid rgba(0,16,93,.15); border-top-color: var(--pink); animation:spin 1s linear infinite; }
    @keyframes spin{ to{ transform: rotate(360deg);} }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
</head>
<body>
  <div id="loadingOverlay" class="loading-overlay">
    <div class="spinner"></div>
    <div class="loading-title">Generando tu cumplido…</div>
    <div class="loading-sub">Esto puede tardar unos segundos mientras personalizamos tu carta.</div>
  </div>
  <main class="wrap">
    <div class="card card-frame" id="card">
      <!-- stickers opcionales (si tienes PNGs decorativos)
      <img src="assets/sticker_flecha.png" class="sticker top-right" alt="">
      <img src="assets/sticker_coroa.png" class="sticker mid-right" alt="">
      -->

      <p class="saludo" id="nombreLine">María,</p>

      <p id="parrafo1">
        Desde pequeña has tenido el coraje de mirar de frente a tus miedos y dar pasos
        que pocos se atreven a dar. Aquella vez que decidiste enfrentarte al público,
        aún con el corazón latiendo fuerte, marcó el inicio de una historia en la que tu
        valentía y determinación serían protagonistas.
      </p>

      <p id="parrafo2">
        Con el tiempo, descubriste el valor de algo que no siempre se ve: tu capacidad
        para escuchar y entender de verdad a los demás, regalándoles un espacio seguro
        y lleno de comprensión. Y, como si eso fuera poco, tu generosidad para ayudar
        sin esperar nada a cambio se ha convertido en un faro que guía, reconforta y deja
        huella. <span class="micro">Eres la prueba de que la verdadera fuerza no siempre se grita… a veces
        se siente en el alma.</span>
      </p>

      <p class="label-adj" id="complimentLabel">El cumplido perfecto para ti es:</p>
      <div class="adjetivo" id="adjetivo">auténtica</div>

      <div class="frase" id="frase">Porque ser tú misma es, y siempre será, tu mayor poder.</div>

      <img src="assets/dove-logo.png" alt="Dove" class="logo-dove">
    </div>

    <div class="share">
      <button id="btnShare" class="btn-share" type="button">
        <img src="assets/share.png" class="share-icon" alt="">
        <span>COMPARTIR</span>
      </button>
    </div>
  </main>

  <script>
    const overlay = document.getElementById('loadingOverlay');
    const minWaitMs = 8000; // 8 segundos mínimos
    const t0 = Date.now();
    function hideOverlayRespectingMinTime(){
      const elapsed = Date.now() - t0;
      const remaining = Math.max(0, minWaitMs - elapsed);
      setTimeout(()=>{ if(overlay) overlay.style.display = 'none'; }, remaining);
    }

    // Lee datos del formulario
    const data = JSON.parse(localStorage.getItem('complimentForm') || "{}");

    // Helper para capitalizar nombre
    const cap = s => (s||"").trim().replace(/\s+/g,' ').replace(/(^|\s)\S/g, m => m.toUpperCase());

    // Helper para capitalizar primera letra y poner resto en minúsculas
    const capFirst = str => str.charAt(0).toUpperCase() + str.slice(1).toLowerCase();

    // Fallbacks por si falta algo
    const nombre = cap(data.name) || "Amiga";
    const logro = data.achievement || "un logro que te llenó de orgullo";
    const apoyo = data.support || "el apoyo de quienes te quieren";
    const sueno = data.dreams || "tus metas para el futuro";
    const consejo = data.advice || "confiar en ti, siempre";

    const p1 = `Desde pequeña has tenido el coraje de mirar de frente a tus miedos y dar pasos que pocos se atreven a dar. Aquella vez que decidiste enfrentarte al público, aun con el corazón latiendo fuerte, marcó el inicio de una historia en la que tu valentía y determinación serían protagonistas. Ese momento —${logro}— es una prueba clara de tu fuerza.`;
    const p2 = `Con el tiempo, descubriste el valor de algo que no siempre se ve: tu capacidad para escuchar y entender de verdad a los demás, regalándoles un espacio seguro y lleno de comprensión. Cuando las cosas se complican, encuentras impulso en ${apoyo}. Y mientras miras hacia adelante, ${sueno} te recuerda que estás construyendo un camino propio. `;

    const cierres = {
      valiente: 'Porque tu valentía abre caminos donde antes había dudas.',
      disciplinada: 'Porque tu constancia convierte los sueños en pasos reales.',
      empática: 'Porque tu escucha abraza y hace sentir a otros en casa.',
      creativa: 'Porque tu imaginación ilumina cada rincón que tocas.',
      auténtica: 'Porque ser tú misma es, y siempre será, tu mayor poder.'
    };

    function runFallback() {
      document.getElementById('nombreLine').textContent = nombre + ',';
      document.getElementById('parrafo1').textContent = p1;
      document.getElementById('parrafo2').textContent = p2 + 'Eres la prueba de que la verdadera fuerza no siempre se grita… a veces se siente en el alma.';

      const keywords = (logro + ' ' + apoyo + ' ' + sueno + ' ' + consejo).toLowerCase();
      let adj = 'auténtica';
      if (keywords.match(/valien|atrev|coraje|miedo|públic/)) adj = 'valiente';
      else if (keywords.match(/constancia|disciplina|esfuerzo|estudio|trabajo/)) adj = 'disciplinada';
      else if (keywords.match(/empática|escuchar|comprensión|apoy/)) adj = 'empática';
      else if (keywords.match(/creativ|arte|dibu|música|escribir|idea/)) adj = 'creativa';

      document.getElementById('adjetivo').textContent = adj;
      document.getElementById('complimentLabel').textContent = 'El cumplido perfecto para ti es:';
    }

    (async () => {
      try {
        const res = await fetch('/api/generate-letter', {
          method: 'POST',
          headers: {'Content-Type':'application/json'},
          body: JSON.stringify({ name:nombre, achievement:logro, support:apoyo, dreams:sueno, advice:consejo })
        });
        if (!res.ok) throw new Error('Network response was not ok');
        const json = await res.json();
        document.getElementById('nombreLine').textContent = (json.name || nombre) + ',';
        document.getElementById('parrafo1').textContent = json.paragraph1 || p1;
        const p2El = document.getElementById('parrafo2');
        if (p2El) { p2El.textContent = ''; p2El.style.display = 'none'; }
        if (json.complimentLine) {
          const parts = String(json.complimentLine).split('\n');
          document.getElementById('complimentLabel').textContent = parts[0] || 'El cumplido perfecto para ti es:';
          document.getElementById('adjetivo').textContent = (parts[1] || json.adjective || 'auténtica').trim();
        } else {
          document.getElementById('complimentLabel').textContent = 'El cumplido perfecto para ti es:';
          document.getElementById('adjetivo').textContent = (json.adjective || 'auténtica');
        }
        document.getElementById('frase').textContent = json.closingLine || cierres['auténtica'];
      } catch(e) {
        runFallback();
      } finally {
        hideOverlayRespectingMinTime();
      }
    })();

    // --- Toast helper ---
    function showToast(msg){
      let t = document.querySelector('.toast');
      if(!t){
        t = document.createElement('div');
        t.className = 'toast';
        document.body.appendChild(t);
      }
      t.textContent = msg;
      t.classList.add('show');
      clearTimeout(window.__toastTimer);
      window.__toastTimer = setTimeout(()=>{ t.classList.remove('show'); }, 2800);
    }

    // --- Descargar captura de la tarjeta ---
    const btnShare = document.getElementById('btnShare');
    btnShare?.addEventListener('click', async () => {
      const card = document.getElementById('card');
      if (!card) return;

      // Asegura scroll top para capturar todo de forma consistente
      window.scrollTo(0,0);

      // Espera un frame por si hay fuentes pendientes
      await new Promise(r => requestAnimationFrame(r));

      try {
        const canvas = await html2canvas(card, {
          backgroundColor: '#ffffff',
          scale: window.devicePixelRatio > 1 ? 2 : 2, // mejor resolución
          useCORS: true
        });
        // --- Generar imagen en formato Historia (1080x1920) con margen y contenido centrado ---
        const srcCanvas = canvas; // lo que capturamos de la tarjeta
        const STORY_W = 1080;
        const STORY_H = 1920;
        const PADDING = 100; // margen visual alrededor del contenido en la historia

        // Crear lienzo destino (historia)
        const storyCanvas = document.createElement('canvas');
        storyCanvas.width = STORY_W;
        storyCanvas.height = STORY_H;
        const ctx = storyCanvas.getContext('2d');

        // Fondo blanco
        ctx.fillStyle = '#ffffff';
        ctx.fillRect(0, 0, STORY_W, STORY_H);

        // Calcular escala para encajar el src dentro del área interna con padding
        const innerW = STORY_W - PADDING * 2;
        const innerH = STORY_H - PADDING * 2;
        const scale = Math.min(innerW / srcCanvas.width, innerH / srcCanvas.height);
        const targetW = Math.round(srcCanvas.width * scale);
        const targetH = Math.round(srcCanvas.height * scale);
        const offsetX = Math.round((STORY_W - targetW) / 2);
        const offsetY = Math.round((STORY_H - targetH) / 2);

        // Dibujar contenido centrado
        ctx.imageSmoothingEnabled = true;
        ctx.imageSmoothingQuality = 'high';
        ctx.drawImage(srcCanvas, offsetX, offsetY, targetW, targetH);

        // (Opcional) guía sutil del margen — desactivado por default
        // ctx.strokeStyle = 'rgba(0,0,0,0.06)';
        // ctx.strokeRect(PADDING, PADDING, innerW, innerH);

        // Preparar Blob/DataURL a partir del lienzo historia
        const storyBlob = await new Promise(resolve => storyCanvas.toBlob(resolve, 'image/png'));
        const storyDataUrl = storyCanvas.toDataURL('image/png');

        // Nombre base del archivo usando el nombre mostrado
        const safeName = (document.getElementById('nombreLine')?.textContent || 'tu-cumplido')
          .replace(/[\,\s]+/g,'-')
          .replace(/[^a-zA-Z0-9-_]/g,'')
          .toLowerCase();
        const fileName = `${safeName}-historia.png`;

        const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);
        const isSafari = /^((?!chrome|android).)*safari/i.test(navigator.userAgent);

        // 1) Intento ideal: Web Share API con archivos (iOS/Android/desktop compatibles)
        if (storyBlob && navigator.canShare && navigator.canShare({ files: [new File([storyBlob], fileName, { type: 'image/png' })] })) {
          try {
            await navigator.share({
              files: [new File([storyBlob], fileName, { type: 'image/png' })],
              title: 'Mi cumplido',
              text: 'Te comparto mi carta ✨'
            });
            showToast('Compartido desde la hoja de compartir.');
            return;
          } catch (shareErr) {
            console.warn('Share cancelado o no disponible, fallback…', shareErr);
          }
        }

        // 2) Android/desktop: descarga directa
        if (!isIOS && !isSafari) {
          const a = document.createElement('a');
          a.href = storyDataUrl; a.download = fileName; document.body.appendChild(a); a.click(); a.remove();
          showToast('Imagen descargada.');
          return;
        }

        // 3) iOS/Safari fallback: abrir en nueva pestaña para "Guardar en Fotos"
        const w = window.open();
        if (w && w.document) {
          w.document.write('<meta name="viewport" content="width=device-width,initial-scale=1">');
          w.document.write('<img src="' + storyDataUrl + '" style="width:100%;height:auto;display:block">');
          showToast('Mantén presionada la imagen y elige “Guardar en Fotos”.');
        } else {
          // Último recurso si bloquea popups
          window.location.href = storyDataUrl;
        }
      } catch (err) {
        console.error('No se pudo generar la captura:', err);
        if(overlay) overlay.style.display = 'none';
        alert('No se pudo generar la imagen. Intenta nuevamente.');
      }
    });
  </script>
</body>
</html>
